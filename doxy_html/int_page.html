<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.8"/>
<title>ArnLib: ArnLib Internals</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
  $(window).load(resizeHeight);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td style="padding-left: 0.5em;">
   <div id="projectname">ArnLib
   &#160;<span id="projectnumber">3.0.x</span>
   </div>
   <div id="projectbrief">Active Registry Network</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.8 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li><a href="examples.html"><span>Examples</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('int_page.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(9)"><span class="SelectionMark">&#160;</span>Properties</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(10)"><span class="SelectionMark">&#160;</span>Friends</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(11)"><span class="SelectionMark">&#160;</span>Macros</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(12)"><span class="SelectionMark">&#160;</span>Pages</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">ArnLib Internals </div>  </div>
</div><!--header-->
<div class="contents">
<div class="toc"><h3>Table of Contents</h3>
<ul><li class="level1"><a href="#int_scriptjobs">ScriptJobs    </a></li>
<li class="level1"><a href="#int_arnmonitor">ArnMonitor    </a></li>
<li class="level1"><a href="#int_destroy">Destroy    </a></li>
</ul>
</div>
<div class="textblock"><p>This document describes internal processes that are relatively complex and by this needs some explanation.</p>
<h1><a class="anchor" id="int_scriptjobs"></a>
ScriptJobs    </h1>
<ul>
<li>Each jobstack ScriptJobs is setup with a ScriptJobFactory wich makes custom interfaces etc.</li>
<li>ScriptJobControl is setup with: Sriptfile, Config (QObject) and InterfaceList. Scriptfile is also copied to a <a class="el" href="class_arn_item.html" title="Handle for an Arn Data Object. ">ArnItem</a>.</li>
<li>ScriptJobControl can be connected to update of script in <a class="el" href="namespace_arn.html">Arn</a>, to make reload possible.</li>
<li>Error text from ScriptJobControl can be connected to a pipe in <a class="el" href="namespace_arn.html">Arn</a> for logging.</li>
<li>ScriptJobControl together with jobpriority define the ScriptJob and is added to ScriptJobs. Error text from Script job is connected to ScriptJobControl.</li>
<li>Starting ScriptJobs in cooperative mode:<ol type="1">
<li>Every ScriptJob is created and setup by corresponding ScriptJobControl</li>
<li>Every ScriptJob is connected to Scheduler (yield etc).</li>
<li>Every ScriptJobControl is connected to ScriptJobs for signaling update of script.</li>
<li>Scheduler is started.</li>
</ol>
</li>
<li>Setup ScriptJob by ScriptJobControl:<ol type="1">
<li>set ScriptJobFactory and Config</li>
<li>Make and add the jobs Interfaces</li>
<li>Evaluate the script (in js engine)</li>
<li>run script function jobInit()</li>
</ol>
</li>
<li>Updating Script in cooperative mode:<ol type="1">
<li>ScriptJobControl gets updated by <a class="el" href="namespace_arn.html">Arn</a> (or other).</li>
<li>ScriptJobControl sends signal to ScriptJobs, which sets an updated flag for the corresponding Script Job.</li>
<li>When scheduling, every updated script will get its sigQuit signal invoked and then reloaded.</li>
<li>Reloading includes creating a new ScriptJob and setting up with ScriptJobControl etc.</li>
</ol>
</li>
<li>Starting ScriptJobs in preemtive mode:<ol type="1">
<li>Every ScriptJob gets its own thread which also is setup with ScriptJobControl and ScriptJobFactory.</li>
<li>Thread is started and it create a ScriptJobSingle where followning steps are done.</li>
<li>ScriptJob is created and setup by ScriptJobControl</li>
<li>ScriptJob is connected to Scheduler (yield etc).</li>
<li>ScriptJobControl is connected to ScriptJobSingle for signaling update of script.</li>
<li>Scheduler is started in ScriptJobSingle (just one job).</li>
</ol>
</li>
<li>Updating Script in preemtive mode:<ol type="1">
<li>ScriptJobControl gets updated by <a class="el" href="namespace_arn.html">Arn</a> (or other).</li>
<li>ScriptJobControl sends signal to ScriptJobSingle, which sets an updated flag and both invokes sigQuit signal to script and calls quit in scriptJob.</li>
<li>ScriptJob aborts its js script engine and posts a custom Quit event with high prio.</li>
<li>When ScriptJob get the Quit event, it will send a QuitRequest signal to ScriptJobSingle.</li>
<li>ScriptJobSingle will get the signal amd detect update flag, which means reloading.</li>
<li>Reloading includes creating a new ScriptJob and setting up with ScriptJobControl etc.</li>
</ol>
</li>
</ul>
<h1><a class="anchor" id="int_arnmonitor"></a>
ArnMonitor    </h1>
<ul>
<li>Monitor starts its actual connection job when its start method is called.</li>
<li>Monitor (at client-side) results in creates an ItemNet with path to monitorPath.</li>
<li>The ItemNet is also put in syncQueue (always main-thread).</li>
<li>Monitor puts the arn-event "monitorStart" in event loop, which makes sure event is sent after Monitor (and its caller) has finished initiializing.</li>
<li>When "monitorStart" is received on local (client) side, the ItemNet will change SyncMode to Monitor. This will resync ItemNet to a Monitor at any server restart.</li>
<li>Now 2 possibilities depending on threading:<ol type="1">
<li>The ItemNet was sent before syncMode Monitor was set. Then server will receive an ordinary ItemNet and do standard setup.</li>
<li>The ItemNet was sent with syncMode Monitor set. The server will detect this and do MonitorSetup on the ItemNet.</li>
</ol>
</li>
<li>When arn-event "monitorStart" is received on server-side, if SyncMode is not already set to "Monitor", server will do MonitorSetup on the ItemNet.</li>
<li>When doing MonitorSetup (at server-side), logic are made to send arn-events when new childs are created, and present childs are directly sent as arn-event.</li>
</ul>
<h1><a class="anchor" id="int_destroy"></a>
Destroy    </h1>
<ul>
<li>Destruction can be locally initiated and affects one link. Destruction can be set as local or global.</li>
<li>Destruction can also be initiated for leaves by the destroy command and arives with a netId. Or it can be with the delete command for a folder (tree).</li>
<li>For leaf, corresponding ItemNet is disabled (set as defunct), which prohibit sending destroy command back to the originator of the command.</li>
<li>The ItemNet is also destroyed in the same way as a locally initiated destruction and affects one link. Destruction is set to be global.</li>
<li>The affected link:s tree is recursively traversed and all links are first marked as retired. Also the retire type is set as LeafLocal, LeafGlobal or Tree.</li>
<li>As the last thing in this recursion each link is sending a Retired <a class="el" href="class_arn_event.html">ArnEvent</a>, ie the leaves are the first to send. The event is sent to the subscriptions (ArnBasicItems or derived) of each link.</li>
<li>If it's a destroy of a tree (folder), a Retired <a class="el" href="class_arn_event.html">ArnEvent</a> is also sent to the tree:s parent and all the way up to the root. The event is sent to the subscriptions (ArnBasicItems) of each link. These events have a marking telling destroy is below.</li>
<li>The Retired <a class="el" href="class_arn_event.html">ArnEvent</a> is handled by each subscribing Item. For <a class="el" href="class_arn_basic_item.html" title="Base class handle for an Arn Data Object. ">ArnBasicItem</a> this is done by its eventhandler, which by default is an internal handler. For <a class="el" href="class_arn_item.html" title="Handle for an Arn Data Object. ">ArnItem</a> this is done by sending a linkDestroyed signal to be handled by application code. The Items is finally closed and by this the link ref counter is decremented.</li>
<li>When the links ref counter is reaching zero, a ZeroRef <a class="el" href="class_arn_event.html">ArnEvent</a> is sent. Also a ZeroRef pending counter is increased.</li>
<li>The event is handled by ArnM::doZerRefLink(), in Main thread. First the ZeroRef pending counter is decreased. Next both ref counter and ZeroRef pending counter is checked to be zero, which indicates that this is the final ZeroRef for this link. This is to prohibit a scenario where the link has been reused during ZeroRef <a class="el" href="class_arn_event.html">ArnEvent</a> delivery. Also this reuse might have been followed by a dropped usage resulting in a second ZeroRef <a class="el" href="class_arn_event.html">ArnEvent</a>.</li>
<li>In ArnM::doZerRefLink() if this is the final ZeroRef, it will set the link ref counter to -1, to mark the link as fully de-referenced. The link and parent (and grand parants ...) are deleted if they don't have any children and ref = -1 and they are marked retired.</li>
<li>When the ArnSync, which is eventHandler for ItemNet, is handling the Retired <a class="el" href="class_arn_event.html">ArnEvent</a>, it will delete the corresponding ItemNet from sync map and all queues. Finally a command can be sent with its netId.</li>
<li>The sent command depends on retire type. For Leaflocal, a nosync command is used. For LeafGlobal, a delete command is used to spread the destruction to server and other clients. The Tree type doesn't send a command at item level.</li>
<li>For tree destroy, <a class="el" href="class_arn_client.html" title="Class for connecting to an Arn Server. ">ArnClient</a> is using a monitoring ArnItemNetEar at each mount point to catch the Retire <a class="el" href="class_arn_event.html">ArnEvent</a> for a tree below. Such an event is resulting in a delete or noSync command is sent, depending on global or local destroy. The command is sent with the path to the destroyed tree.</li>
<li>For tree destroy, <a class="el" href="class_arn_server.html" title="Class for making an Arn Server. ">ArnServer</a> is using a monitoring ArnItemNetEar at root to catch the Retire <a class="el" href="class_arn_event.html">ArnEvent</a> for a tree below. Such an event is resulting in a delete command is sent. The command is sent with the path to the destroyed tree.</li>
<li>When a delete command is echoed back to the originator, it will stop with this only echo as the affected tree is already marked for retire and this will terminate the command. </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Wed May 11 2016 22:22:54 for ArnLib by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.8 </li>
  </ul>
</div>
</body>
</html>
